# Elastic Load Balancing 서비스

## 개요
Elastic Load Balancing(ELB)은 들어오는 애플리케이션 트래픽을 여러 대상(EC2 인스턴스, 컨테이너, IP 주소 등)에 자동으로 분산하는 AWS 서비스입니다. 이 강의에서는 ELB의 기본 개념, 유형, 작동 방식 및 고가용성 아키텍처에서의 활용 방법을 알아봅니다.

## 학습 목표
- Elastic Load Balancing의 개념과 이점 이해
- 다양한 유형의 로드 밸런서와 각각의 사용 사례 학습
- 로드 밸런서 구성 요소 및 작동 방식 이해
- ELB를 활용한 고가용성 아키텍처 설계 방법 습득

## Elastic Load Balancing이란?

### 기본 개념
Elastic Load Balancing은 들어오는 애플리케이션 트래픽을 여러 대상에 자동으로 분산하여 애플리케이션의 내결함성과 가용성을 향상시키는 서비스입니다.

**비유**: ELB는 마치 호텔 프론트 데스크와 같습니다. 손님(트래픽)이 도착하면 현재 가용한 객실(서버)에 적절히 분배하여 모든 객실이 균등하게 사용되도록 합니다.

### ELB의 주요 이점
- **고가용성**: 여러 가용 영역에 걸쳐 트래픽 분산
- **자동 확장**: 트래픽 증가에 따라 자동으로 확장
- **보안 강화**: SSL/TLS 종료, 연결 암호화 지원
- **상태 확인**: 비정상 대상 자동 감지 및 트래픽 우회
- **세션 지속성**: 사용자 세션을 동일한 대상으로 라우팅
- **통합 모니터링**: CloudWatch와 통합된 상세 지표

## Elastic Load Balancing 유형

AWS는 다양한 요구 사항을 충족하기 위해 네 가지 유형의 로드 밸런서를 제공합니다.

### 1. Application Load Balancer (ALB)
HTTP/HTTPS 트래픽을 위한 Layer 7(애플리케이션 계층) 로드 밸런서입니다.

**주요 기능**:
- 경로 기반 라우팅
- 호스트 기반 라우팅
- 컨테이너 및 마이크로서비스 지원
- WebSocket 지원
- HTTP/2 지원
- 고급 요청 라우팅

**사용 사례**:
- 웹 애플리케이션
- 마이크로서비스 아키텍처
- 컨테이너 기반 애플리케이션

**비유**: ALB는 우편물 분류원과 같습니다. 편지(HTTP 요청)의 내용을 확인하고 적절한 부서(서비스)로 전달합니다.

### 2. Network Load Balancer (NLB)
TCP/UDP 트래픽을 위한 Layer 4(전송 계층) 로드 밸런서입니다.

**주요 기능**:
- 초당 수백만 개의 요청 처리
- 매우 낮은 지연 시간
- 고정 IP 주소 제공
- 가용 영역당 하나의 고정 IP
- UDP 프로토콜 지원
- 정적 IP 및 탄력적 IP 지원

**사용 사례**:
- 게임 서버
- IoT 애플리케이션
- 지연 시간에 민감한 애플리케이션
- TCP/UDP 기반 애플리케이션

**비유**: NLB는 고속도로 톨게이트와 같습니다. 차량(패킷)의 내용을 검사하지 않고 빠르게 목적지로 전달합니다.

### 3. Gateway Load Balancer (GWLB)
가상 어플라이언스 배포 및 확장을 위한 로드 밸런서입니다.

**주요 기능**:
- 방화벽, IDS/IPS, 심층 패킷 검사 등의 가상 어플라이언스 지원
- GENEVE 프로토콜(UDP 6081) 사용
- 투명한 네트워크 게이트웨이 및 로드 밸런서 기능 결합

**사용 사례**:
- 네트워크 보안 어플라이언스
- 방화벽 배포
- 침입 탐지/방지 시스템

**비유**: GWLB는 공항 보안 검색대와 같습니다. 모든 승객(트래픽)이 보안 검사를 통과한 후에야 게이트(대상)로 이동할 수 있습니다.

### 4. Classic Load Balancer (CLB)
이전 세대 로드 밸런서로, HTTP/HTTPS 및 TCP 트래픽을 모두 처리합니다.

**주요 기능**:
- EC2-Classic 네트워크 지원
- 기본적인 로드 밸런싱 기능
- Layer 4 및 Layer 7 로드 밸런싱

**사용 사례**:
- 레거시 애플리케이션
- EC2-Classic 네트워크의 애플리케이션

**비유**: CLB는 오래된 교환기와 같습니다. 기본적인 기능은 제공하지만 최신 기능은 부족합니다.

**참고**: AWS는 새로운 애플리케이션에 CLB 대신 ALB 또는 NLB를 사용할 것을 권장합니다.

## 로드 밸런서 구성 요소

### 1. 리스너
클라이언트와 로드 밸런서 간의 연결을 위한 프로토콜 및 포트를 정의합니다.

**구성 요소**:
- 프로토콜 (HTTP, HTTPS, TCP, UDP, TLS)
- 포트 번호
- 리스너 규칙 (ALB의 경우)

**비유**: 리스너는 호텔의 접수 창구와 같습니다. 손님이 처음 접촉하는 지점입니다.

### 2. 대상 그룹
요청을 라우팅할 대상(EC2 인스턴스, IP 주소, Lambda 함수 등)의 논리적 그룹입니다.

**구성 요소**:
- 대상 유형 (인스턴스, IP, Lambda)
- 프로토콜 및 포트
- 상태 확인 설정
- 라우팅 알고리즘

**비유**: 대상 그룹은 호텔의 객실 카테고리(스탠다드, 디럭스, 스위트 등)와 같습니다. 각 카테고리에는 여러 객실이 포함됩니다.

### 3. 규칙 (ALB만 해당)
리스너에서 대상 그룹으로 요청을 라우팅하는 방법을 정의합니다.

**구성 요소**:
- 조건 (경로 패턴, 호스트 헤더, HTTP 헤더, 메서드, 쿼리 문자열 등)
- 우선순위
- 작업 (전달, 리디렉션, 고정 응답 등)

**비유**: 규칙은 호텔 직원이 손님의 요구 사항(비즈니스 여행, 가족 여행 등)에 따라 적절한 객실을 배정하는 것과 같습니다.

### 4. 상태 확인
대상의 가용성을 모니터링하는 메커니즘입니다.

**구성 요소**:
- 프로토콜 및 포트
- 경로 (HTTP/HTTPS의 경우)
- 간격 (확인 빈도)
- 임계값 (정상/비정상 판단 기준)
- 타임아웃

**비유**: 상태 확인은 호텔 직원이 객실의 청소 상태와 준비 여부를 확인하는 것과 같습니다.

## 로드 밸런서 작동 방식

### 1. 트래픽 분산 프로세스
1. 클라이언트가 로드 밸런서의 DNS 이름으로 요청 전송
2. DNS가 로드 밸런서 노드의 IP 주소로 확인
3. 로드 밸런서가 요청 수신
4. 리스너가 요청을 처리하고 규칙 평가 (ALB의 경우)
5. 라우팅 알고리즘에 따라 정상 대상 선택
6. 요청을 선택된 대상으로 전달

### 2. 상태 확인 프로세스
1. 로드 밸런서가 구성된 간격으로 대상에 상태 확인 요청 전송
2. 대상이 구성된 임계값 내에 응답하면 정상으로 간주
3. 대상이 응답하지 않거나 비정상 응답을 보내면 비정상으로 간주
4. 비정상 대상으로의 트래픽 라우팅 중지
5. 대상이 다시 정상 상태가 되면 트래픽 라우팅 재개

### 3. 세션 지속성
동일한 클라이언트의 요청을 동일한 대상으로 라우팅하는 기능입니다.

**방법**:
- **쿠키 기반 지속성** (ALB):
  - 애플리케이션 쿠키 (애플리케이션에서 생성)
  - 로드 밸런서 생성 쿠키 (AWSALB, AWSALBAPP)
- **소스 IP 기반 지속성** (NLB, CLB):
  - 클라이언트의 IP 주소를 기반으로 동일한 대상으로 라우팅

**비유**: 세션 지속성은 호텔 손님이 체크아웃하기 전까지 항상 같은 객실을 사용하는 것과 같습니다.

### 4. 연결 드레이닝
대상을 등록 취소하거나 비정상으로 표시하기 전에 진행 중인 요청을 완료할 수 있도록 하는 기능입니다.

**프로세스**:
1. 대상이 등록 취소되거나 비정상으로 표시됨
2. 새 연결은 해당 대상으로 라우팅되지 않음
3. 기존 연결은 구성된 시간(최대 3,600초) 동안 유지됨
4. 시간이 만료되거나 모든 연결이 완료되면 대상이 제거됨

**비유**: 연결 드레이닝은 호텔에서 객실 수리가 필요할 때, 현재 투숙객이 체크아웃할 때까지 기다리고 새 손님은 받지 않는 것과 같습니다.

## 로드 밸런서 유형별 주요 특징 비교

### Application Load Balancer (ALB)
- **프로토콜**: HTTP, HTTPS
- **OSI 계층**: Layer 7 (애플리케이션)
- **라우팅**: 경로 기반, 호스트 기반, HTTP 헤더, 쿼리 문자열
- **대상 유형**: 인스턴스, IP, Lambda
- **고정 IP**: 지원하지 않음
- **SSL 종료**: 지원
- **세션 지속성**: 쿠키 기반
- **상태 확인**: HTTP, HTTPS, TCP

### Network Load Balancer (NLB)
- **프로토콜**: TCP, UDP, TLS
- **OSI 계층**: Layer 4 (전송)
- **라우팅**: 포트 기반
- **대상 유형**: 인스턴스, IP
- **고정 IP**: 지원 (가용 영역당 1개)
- **SSL 종료**: 지원
- **세션 지속성**: 소스 IP 기반
- **상태 확인**: TCP, HTTP, HTTPS

### Gateway Load Balancer (GWLB)
- **프로토콜**: GENEVE (UDP 6081)
- **OSI 계층**: Layer 3 (네트워크) + Layer 4 (전송)
- **라우팅**: 5-튜플 (소스 IP, 소스 포트, 대상 IP, 대상 포트, 프로토콜)
- **대상 유형**: 인스턴스, IP
- **고정 IP**: 지원하지 않음
- **SSL 종료**: 지원하지 않음
- **세션 지속성**: 5-튜플 해시 기반
- **상태 확인**: TCP, HTTP, HTTPS

### Classic Load Balancer (CLB)
- **프로토콜**: HTTP, HTTPS, TCP
- **OSI 계층**: Layer 4 + 기본 Layer 7
- **라우팅**: 기본 라우팅
- **대상 유형**: EC2-Classic 또는 VPC의 인스턴스
- **고정 IP**: 지원하지 않음
- **SSL 종료**: 지원
- **세션 지속성**: 쿠키 기반 또는 소스 IP 기반
- **상태 확인**: TCP, HTTP, HTTPS

## ELB를 활용한 고가용성 아키텍처

### 1. 다중 가용 영역 배포
여러 가용 영역에 로드 밸런서 노드와 대상을 배포하여 단일 가용 영역 장애에도 서비스 지속

**구성 방법**:
- 최소 2개 이상의 가용 영역 활성화
- 각 가용 영역에 충분한 용량 확보
- 교차 영역 로드 밸런싱 활성화 (선택 사항)

**비유**: 이는 여러 도시에 지점을 두어 한 도시에 문제가 발생해도 서비스를 계속할 수 있는 것과 같습니다.

### 2. Auto Scaling과 통합
Auto Scaling 그룹과 로드 밸런서를 통합하여 수요에 따라 자동으로 용량 조정

**구성 방법**:
- Auto Scaling 그룹의 대상 그룹 지정
- ELB 상태 확인 통합
- 적절한 조정 정책 설정

**비유**: 이는 호텔에서 예약 상황에 따라 직원 수를 자동으로 조정하는 것과 같습니다.

### 3. SSL/TLS 종료 및 암호화
로드 밸런서에서 SSL/TLS 종료를 처리하여 백엔드 서버의 부하 감소

**구성 방법**:
- ACM(AWS Certificate Manager)에서 인증서 프로비저닝
- HTTPS 리스너 구성
- 보안 정책 선택
- 백엔드 암호화 구성 (선택 사항)

**비유**: 이는 보안 검색대에서 모든 보안 검사를 처리하고, 내부에서는 더 빠르게 이동할 수 있게 하는 것과 같습니다.

### 4. 고급 라우팅 전략 (ALB)
콘텐츠 기반 라우팅을 통한 트래픽 최적화 및 마이크로서비스 아키텍처 지원

**구성 예시**:
- 경로 기반 라우팅: `/api/*` → API 서버, `/images/*` → 이미지 서버
- 호스트 기반 라우팅: `api.example.com` → API 서버, `www.example.com` → 웹 서버
- 헤더 기반 라우팅: 특정 헤더 값에 따라 다른 버전으로 라우팅 (A/B 테스트)

**비유**: 이는 우편물 분류 시스템이 주소, 크기, 유형에 따라 다른 처리 경로로 우편물을 보내는 것과 같습니다.

### 5. 장애 격리 및 내결함성
비정상 대상 감지 및 트래픽 우회를 통한 장애 격리

**구성 방법**:
- 적절한 상태 확인 구성
- 상태 확인 간격 및 임계값 최적화
- 연결 드레이닝 활성화
- 대상 그룹 수준의 장애 격리

**비유**: 이는 교통 통제 시스템이 사고 지점을 우회하도록 차량을 다른 경로로 안내하는 것과 같습니다.

## ELB 모범 사례

### 1. 보안 모범 사례
- 최신 보안 정책 사용
- 내부 트래픽에는 내부 로드 밸런서 사용
- 보안 그룹을 통한 트래픽 제한
- AWS WAF와 ALB 통합 (웹 애플리케이션 방화벽)
- 액세스 로그 활성화 및 분석

### 2. 성능 최적화 모범 사례
- 적절한 로드 밸런서 유형 선택
- 충분한 용량 프로비저닝
- 연결 유지 시간 최적화
- 버퍼링 및 타임아웃 설정 조정
- HTTP 지속 연결(Keep-Alive) 활성화

### 3. 비용 최적화 모범 사례
- 필요한 로드 밸런서 유형만 사용
- 사용하지 않는 로드 밸런서 삭제
- 교차 영역 로드 밸런싱 비용 고려
- 적절한 용량 계획

### 4. 모니터링 및 로깅 모범 사례
- CloudWatch 지표 모니터링
- 액세스 로그 활성화
- 경보 설정
- 로그 분석 자동화
- 정기적인 성능 검토

## ELB 고급 기능

### 1. 교차 영역 로드 밸런싱
모든 활성화된 가용 영역의 등록된 대상에 트래픽을 균등하게 분산합니다.

**작동 방식**:
- 활성화 시: 모든 대상에 균등하게 트래픽 분산
- 비활성화 시: 각 로드 밸런서 노드는 해당 가용 영역의 대상에만 트래픽 분산

**비유**: 이는 여러 지점의 직원들이 전체 고객을 균등하게 처리하는 것과 같습니다.

### 2. 고정 응답 및 리디렉션 (ALB)
특정 조건에 따라 고정 HTTP 응답을 반환하거나 다른 URL로 리디렉션합니다.

**사용 사례**:
- 유지 보수 페이지 표시
- HTTP에서 HTTPS로 리디렉션
- 지역별 사이트로 리디렉션

**비유**: 이는 상점이 휴업 중일 때 안내문을 게시하거나 손님을 다른 지점으로 안내하는 것과 같습니다.

### 3. 사용자 인증 (ALB)
Amazon Cognito 또는 OIDC 호환 IdP를 통한 사용자 인증을 지원합니다.

**작동 방식**:
1. 인증되지 않은 사용자가 요청 시 IdP로 리디렉션
2. 사용자가 인증 후 원래 요청으로 리디렉션
3. 로드 밸런서가 인증 정보를 헤더에 추가하여 백엔드로 전달

**비유**: 이는 건물 입구의 보안 요원이 방문자의 신원을 확인한 후 출입 배지를 발급하는 것과 같습니다.

### 4. 고급 요청 라우팅 (ALB)
다양한 조건에 따라 요청을 다른 대상 그룹으로 라우팅합니다.

**조건 유형**:
- 호스트 헤더
- HTTP 메서드
- 경로 패턴
- HTTP 헤더
- 쿼리 문자열
- 소스 IP

**비유**: 이는 공항에서 여행 목적, 비자 유형, 국적 등에 따라 승객을 다른 입국 심사대로 안내하는 것과 같습니다.

### 5. SNI(Server Name Indication) 지원
단일 로드 밸런서에서 여러 TLS 인증서를 사용하여 여러 도메인을 지원합니다.

**작동 방식**:
1. 클라이언트가 TLS 핸드셰이크 중에 호스트 이름 전송
2. 로드 밸런서가 호스트 이름에 맞는 인증서 선택
3. 해당 인증서로 TLS 연결 설정

**비유**: 이는 한 건물에 여러 회사가 입주해 있고, 방문자가 찾아오는 회사에 따라 다른 안내 데스크로 안내하는 것과 같습니다.

## 결론
Elastic Load Balancing은 AWS에서 고가용성, 확장성 및 내결함성을 갖춘 애플리케이션을 구축하기 위한 핵심 서비스입니다. 다양한 유형의 로드 밸런서(ALB, NLB, GWLB, CLB)를 통해 다양한 워크로드 요구 사항을 충족할 수 있으며, 상태 확인, 세션 지속성, 연결 드레이닝과 같은 기능을 활용하여 안정적인 서비스를 제공할 수 있습니다. Auto Scaling과의 통합, 다중 가용 영역 배포, SSL/TLS 종료 등의 기능을 통해 고가용성 아키텍처를 구축할 수 있으며, 교차 영역 로드 밸런싱, 고급 라우팅, 사용자 인증과 같은 고급 기능을 활용하여 더욱 정교한 애플리케이션을 구현할 수 있습니다.

## 참고 자료
- [Elastic Load Balancing 사용 설명서](https://docs.aws.amazon.com/elasticloadbalancing/index.html)
- [Application Load Balancer 사용 설명서](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html)
- [Network Load Balancer 사용 설명서](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html)
- [Gateway Load Balancer 사용 설명서](https://docs.aws.amazon.com/elasticloadbalancing/latest/gateway/introduction.html)
- [Elastic Load Balancing 모범 사례](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/best-practices.html)