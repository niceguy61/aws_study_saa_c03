# VPC 네트워킹 심화

## 개요
Amazon VPC(Virtual Private Cloud)의 네트워킹 구성 요소와 기능을 심층적으로 이해하는 것은 효과적인 클라우드 네트워크 설계의 핵심입니다. 이 강의에서는 VPC 내의 다양한 네트워킹 구성 요소, 연결 옵션, 트래픽 라우팅 및 제어 방법에 대해 자세히 알아봅니다.

## 학습 목표
- VPC 네트워킹 구성 요소의 고급 기능 이해
- 다양한 VPC 연결 옵션과 사용 사례 파악
- 효과적인 트래픽 라우팅 및 제어 방법 학습
- 하이브리드 네트워킹 구성 및 최적화 방법 습득
- VPC 네트워킹 문제 해결 및 모니터링 기법 이해

## VPC 네트워킹 구성 요소 심화

### 인터넷 게이트웨이(IGW) 심화
인터넷 게이트웨이는 VPC와 인터넷 간의 통신을 가능하게 하는 수평적으로 확장 가능하고 중복 구성된 게이트웨이입니다.

#### 작동 원리
인터넷 게이트웨이는 두 가지 주요 기능을 수행합니다:
1. **라우팅 대상 제공**: VPC 라우팅 테이블에서 인터넷 트래픽의 대상으로 사용됨
2. **네트워크 주소 변환(NAT)**: 퍼블릭 IP 주소가 할당된 인스턴스에 대해 NAT 수행

**비유**: 인터넷 게이트웨이는 건물의 정문과 같습니다. 외부 세계(인터넷)와 건물 내부(VPC) 사이의 출입을 관리하고, 방문자(패킷)가 올바른 목적지(인스턴스)로 찾아갈 수 있도록 안내합니다.

#### 고급 구성 및 특징
- **단일 연결**: 하나의 VPC에는 하나의 인터넷 게이트웨이만 연결 가능
- **고가용성**: AWS에서 자동으로 중복성 및 고가용성 제공
- **대역폭 제한 없음**: 트래픽 양에 따라 자동으로 확장
- **보안**: 보안 그룹 및 NACL과 함께 작동하여 트래픽 제어
- **IPv6 지원**: IPv6 트래픽에 대한 게이트웨이 역할 수행

#### 인터넷 게이트웨이 라우팅
퍼블릭 서브넷의 라우팅 테이블에는 인터넷 트래픽을 인터넷 게이트웨이로 보내는 경로가 포함되어야 합니다:
```
대상                 대상
10.0.0.0/16         local
0.0.0.0/0           igw-id
::/0                igw-id (IPv6의 경우)
```

#### 퍼블릭 IP 주소 관리
인터넷 게이트웨이를 통한 인터넷 액세스를 위해서는 인스턴스에 퍼블릭 IP 주소가 필요합니다:
- **탄력적 IP 주소(EIP)**: 고정 퍼블릭 IP 주소, 인스턴스 간 재할당 가능
- **자동 할당 퍼블릭 IP**: 서브넷 설정에 따라 인스턴스 시작 시 자동 할당
- **퍼블릭 IPv6 주소**: IPv6 CIDR 블록이 할당된 서브넷의 인스턴스에 할당 가능

### NAT 게이트웨이 및 NAT 인스턴스 심화
NAT(Network Address Translation) 게이트웨이와 NAT 인스턴스는 프라이빗 서브넷의 인스턴스가 인터넷에 액세스할 수 있게 해주지만, 인터넷에서 이러한 인스턴스에 직접 액세스하는 것은 방지합니다.

#### NAT 게이트웨이 vs NAT 인스턴스

| 특성 | NAT 게이트웨이 | NAT 인스턴스 |
|------|--------------|-------------|
| 관리 | AWS 관리형 | 사용자 관리형 |
| 가용성 | 고가용성(단일 AZ 내) | 수동 구성 필요 |
| 대역폭 | 최대 45Gbps, 자동 확장 | 인스턴스 유형에 따라 제한 |
| 유지 관리 | AWS에서 관리 | 사용자 책임(패치, 업데이트 등) |
| 보안 그룹 | 연결 불가 | 연결 가능 |
| 네트워크 ACL | 지원 | 지원 |
| 포트 포워딩 | 미지원 | 지원 |
| 비용 | 시간당 요금 + 데이터 처리 요금 | EC2 인스턴스 요금 |
| 구현 복잡성 | 낮음 | 높음 |
**비유**: NAT 게이트웨이는 호텔의 프론트 데스크와 같습니다. 호텔 투숙객(프라이빗 인스턴스)은 프론트 데스크를 통해 외부로 전화(요청)를 걸 수 있지만, 외부인은 프론트 데스크를 통해 특정 투숙객에게 직접 연락할 수 없습니다.

#### NAT 게이트웨이 고급 구성
- **가용 영역별 배포**: 각 가용 영역에 별도의 NAT 게이트웨이 배포 권장
- **탄력적 IP 필수**: 각 NAT 게이트웨이에는 탄력적 IP 주소 필요
- **대역폭 자동 확장**: 트래픽 증가에 따라 최대 45Gbps까지 자동 확장
- **연결 추적**: 기본적으로 연결당 5분 유휴 제한 시간 (TCP: 350초, UDP: 30초)
- **포트 매핑 제한**: 동일한 대상, 포트, 프로토콜에 대해 최대 55,000개의 동시 연결 지원

#### NAT 게이트웨이 장애 시나리오
- **단일 AZ 장애**: NAT 게이트웨이가 위치한 AZ에 장애 발생 시 해당 NAT 게이트웨이 사용 불가
- **고가용성 설계**: 각 AZ에 별도의 NAT 게이트웨이 배포 및 라우팅 테이블 구성
- **장애 조치 자동화**: AWS Transit Gateway를 사용한 동적 라우팅 구성 가능

#### NAT 인스턴스 고급 구성
- **소스/대상 확인 비활성화**: NAT 인스턴스에서 필수 설정
- **탄력적 IP 연결**: 고정 퍼블릭 IP 주소 필요
- **보안 그룹 구성**: 인바운드/아웃바운드 트래픽 규칙 설정
- **고가용성 구성**: 자동 복구 설정, 여러 AZ에 배포, 라우팅 테이블 업데이트 자동화
- **성능 최적화**: 향상된 네트워킹 지원 인스턴스 유형 선택

### 이그레스 전용 인터넷 게이트웨이
이그레스 전용 인터넷 게이트웨이(Egress-Only Internet Gateway)는 IPv6 트래픽에 대해 NAT 게이트웨이와 유사한 기능을 제공합니다. 프라이빗 서브넷의 인스턴스가 IPv6를 통해 인터넷에 액세스할 수 있지만, 인터넷에서 이러한 인스턴스에 직접 액세스하는 것은 방지합니다.

#### 주요 특징
- **IPv6 전용**: IPv6 트래픽에만 사용됨 (IPv4에는 NAT 게이트웨이 필요)
- **상태 저장 방식**: 아웃바운드 트래픽에 대한 응답 인바운드 트래픽 허용
- **수평적 확장**: 트래픽 요구 사항에 따라 자동 확장
- **가용성**: 중복 구성으로 고가용성 제공
- **비용**: 추가 비용 없음 (데이터 전송 요금만 적용)

#### 구성 방법
1. VPC에 IPv6 CIDR 블록 할당
2. 서브넷에 IPv6 CIDR 블록 할당
3. 이그레스 전용 인터넷 게이트웨이 생성 및 VPC에 연결
4. 라우팅 테이블에 IPv6 인터넷 트래픽(::/0)을 이그레스 전용 인터넷 게이트웨이로 보내는 경로 추가

#### 라우팅 구성 예시
```
대상                 대상
10.0.0.0/16         local
2001:db8:1234::/48  local (VPC IPv6 CIDR)
::/0                eigw-id (이그레스 전용 인터넷 게이트웨이)
```

## VPC 연결 옵션 심화

### VPC 피어링 심화
VPC 피어링은 두 VPC 간에 트래픽을 라우팅할 수 있게 해주는 네트워킹 연결입니다. 이를 통해 VPC가 마치 동일한 네트워크에 있는 것처럼 통신할 수 있습니다.

#### 고급 구성 및 제한 사항
- **CIDR 중복**: 피어링된 VPC 간에 CIDR 블록이 중복되면 피어링은 가능하지만 중복된 IP 범위 간 통신 불가
- **전이적 피어링 미지원**: A-B, B-C가 피어링되어 있어도 A-C 간 직접 통신 불가
- **리전 간 피어링**: 서로 다른 리전의 VPC 간 피어링 지원
- **계정 간 피어링**: 서로 다른 AWS 계정의 VPC 간 피어링 지원
- **MTU 크기**: 피어링 연결을 통한 점보 프레임(Jumbo Frame) 지원 (최대 9001바이트)
- **DNS 확인**: 피어 VPC의 프라이빗 DNS 호스트 이름을 IP 주소로 확인하도록 설정 가능

#### 라우팅 구성
피어링 연결을 설정한 후에는 각 VPC의 라우팅 테이블에 상대방 VPC의 CIDR 블록을 대상으로 하는 경로를 추가해야 합니다:

```
# VPC A의 라우팅 테이블
대상                 대상
10.0.0.0/16         local (VPC A CIDR)
172.16.0.0/16       pcx-id (VPC B CIDR)

# VPC B의 라우팅 테이블
대상                 대상
172.16.0.0/16       local (VPC B CIDR)
10.0.0.0/16         pcx-id (VPC A CIDR)
```

#### 보안 고려 사항
- **보안 그룹 참조**: 피어링된 VPC의 보안 그룹을 규칙의 소스/대상으로 참조 가능 (동일 리전 내)
- **네트워크 ACL**: 피어링 트래픽도 네트워크 ACL에 의해 필터링됨
- **트래픽 검사**: 피어링 연결을 통한 트래픽은 중간에 검사할 수 없음
- **액세스 제어**: 피어링 요청 수락 시 신중한 검토 필요

#### 일반적인 사용 사례
- **리소스 공유**: 여러 VPC 간에 공통 리소스 공유
- **애플리케이션 분리**: 애플리케이션 구성 요소를 별도의 VPC로 분리하면서 통신 유지
- **계정 간 액세스**: 서로 다른 AWS 계정의 리소스 간 통신
- **다중 리전 애플리케이션**: 지리적으로 분산된 애플리케이션 구성 요소 간 통신

### AWS Transit Gateway 심화
AWS Transit Gateway는 VPC와 온프레미스 네트워크를 연결하는 중앙 허브 역할을 하는 서비스입니다. 이를 통해 복잡한 피어링 관계를 단순화하고 확장 가능한 네트워크 아키텍처를 구축할 수 있습니다.

**비유**: Transit Gateway는 대도시의 중앙 교통 허브와 같습니다. 여러 지역(VPC, 온프레미스 네트워크)에서 오는 모든 교통(네트워크 트래픽)이 이 중앙 허브를 통해 효율적으로 목적지로 라우팅됩니다.

#### 고급 기능 및 특징
- **중앙 집중식 연결**: 여러 VPC, VPN 및 Direct Connect 게이트웨이를 단일 지점에 연결
- **전이적 라우팅**: 연결된 모든 네트워크 간 전이적 라우팅 지원
- **라우팅 테이블**: 여러 라우팅 테이블을 통한 세분화된 트래픽 제어
- **멀티캐스트 지원**: IP 멀티캐스트 트래픽 라우팅 지원
- **대역폭**: 연결당 최대 50Gbps, 자동 확장
- **리전 간 피어링**: 서로 다른 리전의 Transit Gateway 간 피어링 지원
- **라우팅 정책**: 정적 라우팅 및 동적 라우팅(BGP) 지원
- **블랙홀 라우팅**: 특정 CIDR 블록에 대한 트래픽 차단 가능
- **접두사 목록 참조**: 라우팅 테이블에서 접두사 목록 참조 지원

#### Transit Gateway 라우팅
Transit Gateway는 여러 라우팅 테이블을 지원하여 복잡한 라우팅 시나리오를 구현할 수 있습니다:

1. **기본 라우팅 테이블**: 모든 연결이 기본적으로 연결되는 라우팅 테이블
2. **사용자 정의 라우팅 테이블**: 특정 연결 또는 연결 그룹에 대한 사용자 정의 라우팅
3. **라우팅 전파**: 연결에서 CIDR 블록을 자동으로 라우팅 테이블에 전파 가능
4. **블랙홀 라우팅**: 특정 CIDR 블록에 대한 트래픽 차단

#### 라우팅 테이블 연결 및 전파
- **연결(Association)**: 각 연결(VPC, VPN 등)은 하나의 라우팅 테이블과 연결됨
- **전파(Propagation)**: 연결의 CIDR 블록을 하나 이상의 라우팅 테이블에 전파 가능
- **정적 경로**: 수동으로 정적 경로 추가 가능
- **동적 경로**: VPN 연결을 통해 BGP로 학습된 경로 자동 전파 가능

#### 네트워크 세분화 전략
Transit Gateway를 사용한 네트워크 세분화는 보안 및 격리 요구 사항을 충족하는 데 도움이 됩니다:

1. **격리된 라우팅 도메인**: 여러 라우팅 테이블을 사용하여 격리된 라우팅 도메인 생성
2. **선택적 연결**: 특정 VPC 간에만 통신 허용
3. **검사 VPC**: 모든 트래픽을 검사 VPC로 라우팅하여 중앙 집중식 보안 제어 구현
4. **개발/테스트/프로덕션 분리**: 환경별 라우팅 테이블을 통한 분리

#### 일반적인 사용 사례
- **대규모 네트워크 연결**: 수십 또는 수백 개의 VPC 연결
- **하이브리드 클라우드**: AWS와 온프레미스 네트워크 간의 연결
- **멀티 계정 환경**: AWS Organizations의 여러 계정 연결
- **글로벌 네트워크**: 여러 리전에 걸친 네트워크 연결
- **중앙 집중식 네트워크 제어**: 단일 지점에서 모든 네트워크 트래픽 관리

### VPC 엔드포인트 심화
VPC 엔드포인트를 사용하면 인터넷 게이트웨이, NAT 장치, VPN 연결 또는 AWS Direct Connect 연결 없이도 AWS 서비스에 비공개로 연결할 수 있습니다.

#### 게이트웨이 엔드포인트 vs 인터페이스 엔드포인트

| 특성 | 게이트웨이 엔드포인트 | 인터페이스 엔드포인트 |
|------|-------------------|-------------------|
| 지원 서비스 | Amazon S3, DynamoDB | 대부분의 AWS 서비스 |
| 구현 방식 | 라우팅 테이블 항목 | 탄력적 네트워크 인터페이스(ENI) |
| 가용성 | 리전 내 모든 AZ | 특정 AZ에 배포 |
| 대역폭 | 제한 없음 | ENI 대역폭 제한 적용 |
| 요금 | 무료 | 시간당 요금 + 데이터 처리 요금 |
| 프라이빗 DNS | 해당 없음 | 선택적으로 활성화 가능 |
| 보안 | 엔드포인트 정책 | 보안 그룹, 엔드포인트 정책 |
| VPC 외부 액세스 | 불가능 | PrivateLink를 통해 가능 |

#### 게이트웨이 엔드포인트 고급 구성
- **라우팅 테이블 통합**: 특정 라우팅 테이블과 연결
- **접두사 목록**: AWS 서비스의 IP 범위를 대상으로 하는 라우팅 테이블 항목 생성
- **엔드포인트 정책**: 엔드포인트를 통한 액세스 제어
- **리전 제한**: 동일한 리전 내의 서비스에만 액세스 가능
- **S3 버킷 정책**: 특정 엔드포인트에서의 액세스만 허용하도록 구성 가능

#### 인터페이스 엔드포인트 고급 구성
- **가용 영역 배포**: 각 가용 영역에 별도의 ENI 배포 가능
- **프라이빗 DNS**: AWS 서비스의 기본 DNS 이름을 사용하여 액세스 가능
- **보안 그룹**: ENI에 보안 그룹 연결하여 트래픽 제어
- **TCP 트래픽만 지원**: UDP 트래픽은 지원되지 않음
- **엔드포인트 서비스**: 자체 서비스를 VPC 엔드포인트 서비스로 제공 가능

#### AWS PrivateLink
AWS PrivateLink는 VPC, AWS 서비스 및 온프레미스 애플리케이션 간에 프라이빗 연결을 제공합니다. 인터페이스 VPC 엔드포인트의 기반 기술입니다.

**주요 특징**:
- **프라이빗 연결**: 공용 인터넷을 통과하지 않는 프라이빗 연결
- **서비스 제공**: 자체 서비스를 다른 AWS 고객에게 제공 가능
- **확장성**: 수천 개의 VPC에서 동시에 액세스 가능
- **보안**: 트래픽이 공용 인터넷에 노출되지 않음
- **간소화된 네트워크**: 방화벽 규칙, NAT 장치 또는 인터넷 게이트웨이 불필요

**일반적인 사용 사례**:
- **SaaS 통합**: SaaS 제품을 고객 VPC와 안전하게 통합
- **공유 서비스**: 여러 VPC 간에 공통 서비스 공유
- **하이브리드 클라우드**: 온프레미스 애플리케이션과 AWS 서비스 간의 프라이빗 연결
- **규제 준수**: 공용 인터넷을 통과하지 않는 통신이 필요한 규제 요구 사항 충족

## 트래픽 라우팅 및 제어 심화

### 라우팅 테이블 고급 기능
라우팅 테이블은 VPC 내의 네트워크 트래픽 흐름을 제어하는 핵심 구성 요소입니다.

#### 라우팅 우선순위 규칙
AWS는 다음과 같은 우선순위로 라우팅 결정을 내립니다:
1. **가장 구체적인 경로**: 가장 긴 접두사 일치 (예: /32가 /16보다 우선)
2. **정적 경로**: 수동으로 구성된 경로
3. **전파된 경로**: VPN 또는 Direct Connect를 통해 전파된 경로
4. **동적 경로**: BGP를 통해 학습된 경로
5. **기본 경로**: 가장 일반적인 경로 (0.0.0.0/0 또는 ::/0)

#### 고급 라우팅 시나리오
- **접두사 목록 참조**: 여러 CIDR 블록을 하나의 접두사 목록으로 그룹화하여 참조
- **블랙홀 라우팅**: 특정 대상에 대한 트래픽 차단
- **더 구체적인 경로 추가**: 특정 트래픽을 다른 경로로 유도
- **게이트웨이 라우팅 테이블**: 인터넷 게이트웨이 또는 가상 프라이빗 게이트웨이에 연결된 라우팅 테이블
- **전송 게이트웨이 라우팅**: Transit Gateway 연결을 통한 복잡한 라우팅 시나리오

#### 라우팅 테이블 설계 모범 사례
- **단순성 유지**: 가능한 한 라우팅 구성을 단순하게 유지
- **일관된 명명 규칙**: 라우팅 테이블 및 경로에 대한 명확한 명명 규칙 사용
- **문서화**: 라우팅 결정 및 구성 문서화
- **자동화**: 인프라 코드(IaC)를 통한 라우팅 구성 자동화
- **중복 경로 방지**: 중복 또는 충돌하는 경로 방지
- **테스트**: 라우팅 변경 사항을 프로덕션에 적용하기 전에 테스트

### 보안 그룹 고급 기능
보안 그룹은 인스턴스 수준에서 작동하는 상태 저장 방화벽으로, 인바운드 및 아웃바운드 트래픽을 제어합니다.

#### 상태 저장 특성의 영향
보안 그룹의 상태 저장 특성은 다음과 같은 영향을 미칩니다:
- **반환 트래픽 자동 허용**: 허용된 인바운드 트래픽에 대한 응답은 아웃바운드 규칙에 관계없이 자동으로 허용됨
- **연결 추적**: 각 연결의 상태를 추적하여 유효한 반환 트래픽 식별
- **연결 제한 시간**: 비활성 연결은 일정 시간 후 제거됨 (TCP: 600초, UDP: 180초)
- **연결 추적 제한**: 인스턴스 유형에 따라 추적할 수 있는 최대 연결 수 제한

#### 보안 그룹 참조
보안 그룹은 다른 보안 그룹을 소스 또는 대상으로 참조할 수 있습니다:
- **동일 VPC 내**: 동일한 VPC 내의 다른 보안 그룹 참조 가능
- **피어링된 VPC**: 동일한 리전 내에서 피어링된 VPC의 보안 그룹 참조 가능
- **참조 체인**: 보안 그룹 A가 B를 참조하고 B가 C를 참조하는 체인 구성 가능
- **자체 참조**: 보안 그룹이 자신을 참조하여 동일한 보안 그룹에 속한 인스턴스 간 통신 허용 가능

#### 보안 그룹 설계 모범 사례
- **최소 권한 원칙**: 필요한 최소한의 액세스만 허용
- **기능별 보안 그룹**: 웹 서버, 애플리케이션 서버, 데이터베이스 등 기능별로 별도의 보안 그룹 생성
- **계층적 설계**: 보안 그룹을 계층적으로 구성하여 재사용성 및 관리 용이성 향상
- **명확한 설명**: 각 규칙에 대한 명확한 설명 추가
- **정기적인 검토**: 불필요한 규칙 제거 및 최신 보안 요구 사항 반영
- **태그 지정**: 효과적인 관리를 위한 태그 사용

### 네트워크 ACL 고급 기능
네트워크 ACL(NACL)은 서브넷 수준에서 작동하는 상태 비저장 방화벽으로, 서브넷 내외로 오가는 트래픽을 제어합니다.

#### 상태 비저장 특성의 영향
NACL의 상태 비저장 특성은 다음과 같은 영향을 미칩니다:
- **인바운드/아웃바운드 규칙 분리**: 인바운드 및 아웃바운드 트래픽에 대해 별도의 규칙 필요
- **반환 트래픽 명시적 허용**: 반환 트래픽을 위한 규칙을 명시적으로 구성해야 함
- **임시 포트 고려**: 클라이언트의 임시 포트(1024-65535)에 대한 아웃바운드/인바운드 규칙 필요
- **연결 상태 미추적**: 각 패킷이 독립적으로 평가됨

#### 규칙 평가 순서
NACL 규칙은 번호 순서대로 평가됩니다:
- **낮은 번호 우선**: 가장 낮은 번호의 규칙부터 평가
- **첫 번째 일치 적용**: 트래픽과 일치하는 첫 번째 규칙이 적용됨
- **기본 규칙**: 다른 규칙과 일치하지 않는 경우 기본 규칙(번호 *) 적용
- **권장 번호 지정**: 규칙 번호 간에 간격을 두어 나중에 규칙 삽입 용이하게 함 (예: 100, 200, 300...)

#### NACL vs 보안 그룹 활용 전략
NACL과 보안 그룹은 상호 보완적인 보안 계층을 제공합니다:

| 사용 사례 | NACL | 보안 그룹 |
|---------|------|---------|
| 기본 방어 계층 | ✓ | |
| 특정 IP 차단 | ✓ | |
| 서브넷 수준 격리 | ✓ | |
| 인스턴스 수준 제어 | | ✓ |
| 애플리케이션 계층 보안 | | ✓ |
| 동적 규칙 참조 | | ✓ |
| 상태 저장 검사 | | ✓ |

#### NACL 설계 모범 사례
- **기본 거부**: 기본적으로 모든 트래픽을 거부하고 필요한 트래픽만 명시적으로 허용
- **계층적 방어**: NACL을 보안 그룹과 함께 사용하여 심층 방어 구현
- **단순성 유지**: 가능한 한 NACL 규칙을 단순하게 유지
- **임시 포트 범위 고려**: 클라이언트 임시 포트에 대한 규칙 포함
- **문서화**: 각 규칙의 목적 및 기능 문서화
- **정기적인 검토**: 불필요한 규칙 제거 및 최신 보안 요구 사항 반영

## 하이브리드 네트워킹 심화

### AWS Site-to-Site VPN 심화
AWS Site-to-Site VPN은 온프레미스 네트워크와 AWS VPC 간에 암호화된 연결을 제공합니다.

#### 고급 구성 옵션
- **가상 프라이빗 게이트웨이(VGW)**: VPC 측의 VPN 종단점
- **고객 게이트웨이(CGW)**: 온프레미스 측의 VPN 종단점
- **전송 게이트웨이 VPN 연결**: Transit Gateway를 VPN 종단점으로 사용
- **정적 vs 동적 라우팅**: BGP(Border Gateway Protocol)를 통한 동적 라우팅 또는 정적 라우팅
- **중복 터널**: 각 VPN 연결에 두 개의 터널 제공 (고가용성)
- **터널 옵션**: IKE 버전, 암호화 알고리즘, DH 그룹, 수명 등 구성 가능
- **VPN CloudHub**: 여러 사이트를 AWS VPN을 통해 연결

#### 고가용성 VPN 설계
- **중복 고객 게이트웨이**: 서로 다른 위치 또는 장치에 여러 고객 게이트웨이 구성
- **중복 가상 프라이빗 게이트웨이**: 여러 VPC에 걸쳐 중복성 제공
- **Transit Gateway 활용**: 여러 VPC에 대한 중복 VPN 연결 단순화
- **BGP 라우팅**: 동적 라우팅을 통한 자동 장애 조치
- **Equal Cost Multi-Path(ECMP)**: Transit Gateway에서 여러 경로 간 트래픽 분산

#### VPN 성능 최적화
- **최대 처리량**: 각 VPN 터널은 최대 약 1.25Gbps 지원
- **MTU 설정**: VPN 연결의 MTU는 1446바이트로 제한됨
- **TCP MSS 클램핑**: TCP 최대 세그먼트 크기 조정으로 단편화 방지
- **여러 VPN 터널**: 더 높은 대역폭을 위해 여러 VPN 연결 사용
- **Accelerated VPN**: 글로벌 AWS 네트워크를 활용한 가속화된 VPN 연결

### AWS Direct Connect 심화
AWS Direct Connect는 온프레미스 네트워크와 AWS 간에 전용 네트워크 연결을 제공합니다.

#### 연결 유형 및 용량
- **전용 연결**: 1Gbps, 10Gbps, 100Gbps 용량
- **호스팅 연결**: 50Mbps, 100Mbps, 200Mbps, 300Mbps, 400Mbps, 500Mbps, 1Gbps, 2Gbps, 5Gbps, 10Gbps
- **Direct Connect 게이트웨이**: 여러 리전의 VPC에 연결
- **LAG(Link Aggregation Group)**: 여러 연결을 하나의 논리적 연결로 결합
- **MAC Security(MACsec)**: 전용 10Gbps 및 100Gbps 연결에 대한 계층 2 암호화

#### 가상 인터페이스(VIF) 유형
- **프라이빗 VIF**: VPC에 대한 프라이빗 연결
- **퍼블릭 VIF**: AWS 퍼블릭 서비스에 대한 연결
- **전송 VIF**: Direct Connect 게이트웨이를 통한 Transit Gateway 연결
- **VIF 최대 MTU**: 1500 또는 9001(점보 프레임)
- **VLAN 태그**: 각 VIF에 고유한 VLAN ID 필요

#### 고가용성 설계
- **여러 위치**: 서로 다른 Direct Connect 위치에 연결
- **여러 서비스 제공업체**: 서로 다른 서비스 제공업체를 통한 연결
- **VPN 백업**: Direct Connect 장애 시 VPN으로 장애 조치
- **LAG 중복성**: 여러 물리적 연결을 포함하는 LAG 구성
- **SLA 고려사항**: 다양한 고가용성 설계에 따른 SLA 수준

#### 라우팅 고려 사항
- **BGP 세션**: 각 VIF에 대한 BGP 피어링 세션 설정
- **AS_PATH 길이**: BGP 경로 선택에 영향을 미치는 AS_PATH 속성
- **BGP 커뮤니티**: 특정 라우팅 정책 적용을 위한 BGP 커뮤니티 태그
- **접두사 필터링**: 특정 접두사만 허용하도록 BGP 필터 구성
- **로컬 기본 설정**: 여러 경로 중에서 선호하는 경로 지정

### 하이브리드 연결 패턴
다양한 하이브리드 연결 패턴을 통해 온프레미스 네트워크와 AWS 클라우드를 효과적으로 통합할 수 있습니다.

#### VPN 전용 패턴
- **장점**: 구현 용이성, 낮은 초기 비용, 빠른 설정
- **단점**: 대역폭 제한, 인터넷 의존성, 변동성 있는 지연 시간
- **사용 사례**: 소규모 워크로드, 개발/테스트 환경, 임시 연결

#### Direct Connect 전용 패턴
- **장점**: 일관된 성능, 높은 대역폭, 낮은 지연 시간, 예측 가능한 비용
- **단점**: 높은 초기 비용, 긴 설정 시간, 단일 연결 시 장애 지점
- **사용 사례**: 대규모 데이터 전송, 지연 시간에 민감한 애플리케이션, 규제 대상 워크로드

#### Direct Connect + VPN 백업 패턴
- **장점**: 고가용성, Direct Connect의 성능과 VPN의 중복성 결합
- **단점**: 구성 복잡성, 두 연결 유형 모두에 대한 비용
- **사용 사례**: 미션 크리티컬 워크로드, 고가용성이 필요한 프로덕션 환경

#### Transit Gateway 기반 하이브리드 패턴
- **장점**: 중앙 집중식 연결, 확장성, 단순화된 관리, 전이적 라우팅
- **단점**: 추가 비용, 단일 리전 제한(리전 간 피어링 필요)
- **사용 사례**: 여러 VPC 및 온프레미스 위치 연결, 대규모 네트워크, 복잡한 라우팅 요구 사항

#### SD-WAN 통합 패턴
- **장점**: 기존 WAN 인프라 활용, 지능적인 트래픽 라우팅, 중앙 집중식 관리
- **단점**: 추가 SD-WAN 장비 및 소프트웨어 비용, 구성 복잡성
- **사용 사례**: 글로벌 네트워크, 여러 클라우드 제공업체 연결, WAN 최적화 필요

## VPC 네트워킹 문제 해결 및 모니터링

### VPC 흐름 로그
VPC 흐름 로그는 VPC의 네트워크 인터페이스에서 송수신되는 IP 트래픽에 대한 정보를 캡처합니다.

#### 고급 구성 옵션
- **집계 간격**: 1분 또는 10분 (기본값: 10분)
- **최대 집계 간격**: 1분 집계의 경우 최대 10분, 10분 집계의 경우 최대 1시간
- **로그 형식 사용자 지정**: 캡처할 필드 선택
- **파티션 기준**: 시간별 또는 접두사별 로그 파티션
- **Hive 호환 S3 접두사**: Hive 기반 도구와의 호환성을 위한 접두사 형식
- **로그 대상**: CloudWatch Logs, S3, Kinesis Data Firehose

#### 흐름 로그 레코드 형식
기본 흐름 로그 형식에는 다음 필드가 포함됩니다:
```
<version> <account-id> <interface-id> <srcaddr> <dstaddr> <srcport> <dstport> <protocol> <packets> <bytes> <start> <end> <action> <log-status>
```

추가 필드 옵션:
- **vpc-id**: 트래픽이 기록된 VPC의 ID
- **subnet-id**: 트래픽이 기록된 서브넷의 ID
- **instance-id**: 트래픽이 기록된 인스턴스의 ID
- **tcp-flags**: TCP 플래그의 비트 마스크 값
- **type**: 트래픽 유형(IPv4, IPv6)
- **pkt-srcaddr**: 패킷 소스 IP 주소
- **pkt-dstaddr**: 패킷 대상 IP 주소
- **region**: 흐름 로그가 생성된 리전
- **az-id**: 트래픽이 기록된 가용 영역의 ID
- **sublocation-type**: 서브넷 위치 유형
- **sublocation-id**: 서브넷 위치 ID

#### 흐름 로그 분석 및 활용
- **보안 분석**: 비정상적인 트래픽 패턴 및 잠재적 보안 위협 식별
- **네트워크 문제 해결**: 연결 문제 및 라우팅 오류 진단
- **규정 준수**: 네트워크 트래픽 감사 및 규정 준수 요구 사항 충족
- **최적화**: 네트워크 사용 패턴 분석 및 최적화 기회 식별
- **도구 통합**: Amazon Athena, Amazon QuickSight, 서드파티 SIEM 도구와 통합

### 네트워크 문제 해결 기법
VPC 네트워킹 문제를 효과적으로 진단하고 해결하기 위한 체계적인 접근 방식입니다.

#### 연결 문제 해결
1. **기본 연결 확인**:
   - 인스턴스 상태 확인
   - 보안 그룹 및 NACL 규칙 검토
   - 라우팅 테이블 확인
   - 네트워크 인터페이스 상태 확인

2. **인터넷 연결 문제**:
   - 인터넷 게이트웨이 연결 확인
   - 퍼블릭 IP 또는 탄력적 IP 할당 확인
   - 라우팅 테이블에 인터넷 게이트웨이로의 경로 확인
   - 소스/대상 확인 설정 검토

3. **VPC 피어링 문제**:
   - 피어링 연결 상태 확인
   - 양쪽 VPC의 라우팅 테이블 확인
   - CIDR 블록 중복 확인
   - DNS 확인 설정 검토

4. **VPN 연결 문제**:
   - 터널 상태 확인
   - 고객 게이트웨이 및 가상 프라이빗 게이트웨이 구성 검토
   - BGP 상태 확인 (동적 라우팅 사용 시)
   - 방화벽 및 보안 그룹 규칙 검토

5. **Direct Connect 문제**:
   - 물리적 연결 상태 확인
   - 가상 인터페이스 상태 확인
   - BGP 피어링 상태 확인
   - VLAN 및 BGP 구성 검토

#### 네트워크 성능 문제 해결
1. **대역폭 병목 현상**:
   - 인스턴스 유형의 네트워크 성능 제한 확인
   - 인스턴스 네트워크 사용률 모니터링
   - 향상된 네트워킹 활성화 여부 확인
   - 배치 그룹 사용 고려

2. **지연 시간 문제**:
   - 리소스 위치 및 가용 영역 확인
   - 네트워크 경로 추적
   - MTU 설정 및 단편화 확인
   - Direct Connect 또는 AWS Global Accelerator 사용 고려

3. **패킷 손실**:
   - 네트워크 인터페이스 오류 확인
   - 흐름 로그에서 삭제된 패킷 분석
   - 대역폭 제한 및 버스트 용량 확인
   - 네트워크 ACL 및 보안 그룹 규칙 검토

#### 문제 해결 도구
- **VPC 흐름 로그**: 네트워크 트래픽 분석
- **CloudWatch 지표**: 네트워크 성능 모니터링
- **VPC Reachability Analyzer**: 네트워크 경로 분석
- **EC2 인스턴스 연결 테스트**: 기본 연결 확인
- **traceroute 및 ping**: 네트워크 경로 및 지연 시간 확인
- **tcpdump**: 패킷 수준 분석
- **AWS Network Manager**: 글로벌 네트워크 가시성

## 결론
VPC 네트워킹은 AWS 클라우드 인프라의 핵심 구성 요소입니다. 다양한 네트워킹 구성 요소, 연결 옵션, 트래픽 라우팅 및 제어 방법을 심층적으로 이해함으로써 안전하고 확장 가능하며 고성능의 네트워크 아키텍처를 설계할 수 있습니다. 하이브리드 네트워킹 구성을 통해 온프레미스 환경과 AWS 클라우드를 원활하게 통합하고, 효과적인 문제 해결 및 모니터링 기법을 활용하여 네트워크 문제를 신속하게 진단하고 해결할 수 있습니다.

## 참고 자료
- [Amazon VPC 사용 설명서](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)
- [AWS 네트워킹 및 콘텐츠 전송 블로그](https://aws.amazon.com/blogs/networking-and-content-delivery/)
- [AWS Direct Connect 사용 설명서](https://docs.aws.amazon.com/directconnect/latest/UserGuide/Welcome.html)
- [AWS Site-to-Site VPN 사용 설명서](https://docs.aws.amazon.com/vpn/latest/s2svpn/VPC_VPN.html)
- [Transit Gateway 사용 설명서](https://docs.aws.amazon.com/vpc/latest/tgw/what-is-transit-gateway.html)
- [VPC 엔드포인트 및 PrivateLink 가이드](https://docs.aws.amazon.com/vpc/latest/privatelink/what-is-privatelink.html)
- [VPC 흐름 로그 사용 설명서](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html)