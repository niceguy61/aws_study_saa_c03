# VPC 개념 및 설계 원칙

## 개요
Amazon Virtual Private Cloud(VPC)는 AWS 클라우드 내에서 논리적으로 격리된 가상 네트워크를 제공하는 서비스입니다. VPC를 사용하면 IP 주소 범위, 서브넷, 라우팅 테이블, 네트워크 게이트웨이 등의 네트워크 환경을 완벽하게 제어할 수 있습니다. 이 강의에서는 VPC의 기본 개념, 구성 요소, 설계 원칙 및 모범 사례에 대해 알아봅니다.

## 학습 목표
- VPC의 정의와 목적 이해
- VPC의 주요 구성 요소 파악
- VPC 설계 원칙 및 모범 사례 학습
- 다양한 VPC 설계 패턴 이해
- IP 주소 계획 방법 습득

## VPC의 정의 및 목적

### VPC란?
Amazon VPC(Virtual Private Cloud)는 AWS 클라우드 내에서 사용자가 정의한 가상 네트워크입니다. 이 가상 네트워크는 AWS의 확장 가능한 인프라를 사용하면서도 기존 데이터 센터에서 운영하는 전통적인 네트워크와 매우 유사합니다.

**비유**: VPC는 대형 건물 내에서 특정 회사나 부서를 위해 할당된 전용 공간과 같습니다. 건물의 기본 인프라(전기, 수도, 냉난방)를 공유하면서도 자체 출입 통제, 내부 구조 및 보안 시스템을 갖춘 독립적인 공간을 가질 수 있습니다.

### VPC의 주요 목적
1. **논리적 격리**: AWS 클라우드 내에서 다른 고객 및 리소스로부터 네트워크 격리
2. **네트워크 제어**: IP 주소 범위, 서브넷, 라우팅 테이블 등을 완벽하게 제어
3. **보안 강화**: 보안 그룹, 네트워크 ACL 등을 통한 다중 계층 보안
4. **하이브리드 클라우드 지원**: 온프레미스 네트워크와의 안전한 연결
5. **규정 준수**: 네트워크 격리 및 보안 요구 사항 충족

### VPC의 주요 특징
- **리전 기반 서비스**: 각 VPC는 특정 AWS 리전 내에 존재
- **다중 AZ 지원**: 여러 가용 영역에 걸쳐 리소스 배포 가능
- **사용자 정의 IP 주소 범위**: RFC 1918에 정의된 프라이빗 IP 주소 범위 사용
- **서브넷 구성**: 다양한 목적에 맞게 서브넷 구성 가능
- **라우팅 제어**: 사용자 정의 라우팅 테이블 구성
- **다양한 연결 옵션**: 인터넷, VPN, Direct Connect 등을 통한 연결
- **무료 서비스**: VPC 자체는 추가 비용 없이 사용 가능 (연결 옵션은 비용 발생 가능)

## VPC 구성 요소

### 기본 구성 요소
VPC는 다양한 구성 요소로 이루어져 있으며, 이들이 함께 작동하여 완전한 네트워크 환경을 제공합니다.

#### 1. VPC
- AWS 계정 내의 논리적으로 격리된 가상 네트워크
- CIDR 블록으로 정의된 IP 주소 범위 (예: 10.0.0.0/16)
- 리전 내에서 여러 가용 영역에 걸쳐 있음
- 계정당 리전별 기본 5개 VPC 제한 (증가 요청 가능)

#### 2. 서브넷
- VPC 내의 IP 주소 범위 세그먼트
- 단일 가용 영역 내에 존재
- 퍼블릭 또는 프라이빗으로 구성 가능
- CIDR 블록으로 정의 (예: 10.0.1.0/24)
- 각 서브넷의 처음 4개와 마지막 1개 IP 주소는 AWS에서 예약

#### 3. 라우팅 테이블
- 네트워크 트래픽의 경로를 결정하는 규칙 집합
- 각 서브넷은 하나의 라우팅 테이블과 연결
- 기본적으로 로컬 VPC 트래픽을 허용하는 규칙 포함
- 사용자 정의 라우팅 규칙 추가 가능

#### 4. 인터넷 게이트웨이 (IGW)
- VPC와 인터넷 간의 통신을 가능하게 하는 게이트웨이
- 수평적으로 확장 가능하고 가용성이 높은 중복 구성 요소
- 퍼블릭 서브넷의 리소스에 인터넷 액세스 제공
- NAT 기능 제공 (퍼블릭 IP를 가진 인스턴스의 경우)

#### 5. NAT 게이트웨이/인스턴스
- 프라이빗 서브넷의 리소스에 아웃바운드 인터넷 액세스 제공
- 인바운드 인터넷 트래픽 차단
- NAT 게이트웨이: AWS 관리형 서비스, 고가용성
- NAT 인스턴스: 사용자 관리형, 직접 구성 및 관리 필요

#### 6. 보안 그룹
- 인스턴스 수준의 가상 방화벽
- 상태 저장(Stateful) 패킷 필터링
- 허용 규칙만 지정 가능 (기본적으로 모든 트래픽 거부)
- 인스턴스별로 여러 보안 그룹 할당 가능
- 소스/대상 IP, 프로토콜, 포트 기반 규칙

#### 7. 네트워크 ACL (NACL)
- 서브넷 수준의 가상 방화벽
- 상태 비저장(Stateless) 패킷 필터링
- 허용 및 거부 규칙 모두 지정 가능
- 규칙 번호에 따라 순서대로 평가
- 각 서브넷은 하나의 NACL과 연결

### 고급 구성 요소

#### 1. VPC 엔드포인트
- AWS 서비스에 대한 프라이빗 연결 제공
- 인터넷 게이트웨이, NAT, VPN 또는 Direct Connect 없이 접근 가능
- 유형:
  - **인터페이스 엔드포인트**: ENI 기반, 대부분의 AWS 서비스 지원
  - **게이트웨이 엔드포인트**: 라우팅 테이블 기반, S3 및 DynamoDB 지원

#### 2. VPC 피어링
- 두 VPC 간의 직접적인 네트워크 연결
- 동일 계정 또는 다른 계정의 VPC 연결 가능
- 동일 리전 또는 다른 리전의 VPC 연결 가능
- 전이적 피어링 미지원 (A-B-C 연결 시 A-C 직접 연결 필요)

#### 3. Transit Gateway
- 여러 VPC 및 온프레미스 네트워크를 연결하는 중앙 허브
- 스타형(hub-and-spoke) 아키텍처 구현
- 복잡한 피어링 관계 단순화
- 리전 간 피어링 지원

#### 4. VPN 연결
- **Site-to-Site VPN**: 온프레미스 네트워크와 VPC 연결
- **Client VPN**: 원격 사용자와 VPC 연결
- IPsec 프로토콜 사용
- 가상 프라이빗 게이트웨이(VGW) 또는 Transit Gateway 활용

#### 5. Direct Connect
- AWS와 온프레미스 간의 전용 프라이빗 네트워크 연결
- 높은 대역폭, 낮은 지연 시간
- 일관된 네트워크 성능
- 데이터 전송 비용 절감
- 보안 강화

#### 6. 흐름 로그
- VPC, 서브넷 또는 네트워크 인터페이스의 IP 트래픽 정보 캡처
- 네트워크 모니터링, 문제 해결 및 보안 분석에 유용
- CloudWatch Logs 또는 S3에 저장 가능
- 거부된 트래픽 분석에 특히 유용

## VPC 설계 원칙

### IP 주소 계획
효과적인 IP 주소 계획은 확장 가능하고 관리하기 쉬운 VPC 설계의 기초입니다.

#### CIDR 블록 선택
- **VPC CIDR 크기**: 일반적으로 /16 ~ /20 범위 사용
  - /16 (65,536 IP 주소)
  - /17 (32,768 IP 주소)
  - /18 (16,384 IP 주소)
  - /19 (8,192 IP 주소)
  - /20 (4,096 IP 주소)

- **프라이빗 IP 주소 범위** (RFC 1918):
  - 10.0.0.0/8 (10.0.0.0 - 10.255.255.255)
  - 172.16.0.0/12 (172.16.0.0 - 172.31.255.255)
  - 192.168.0.0/16 (192.168.0.0 - 192.168.255.255)

- **고려 사항**:
  - 현재 및 미래의 IP 주소 요구 사항
  - 온프레미스 네트워크와의 중복 방지
  - VPC 피어링 시 CIDR 중복 방지
  - 서브넷 분할 용이성

#### 서브넷 설계
- **서브넷 크기**: 일반적으로 /24 ~ /27 범위 사용
  - /24 (256 IP 주소)
  - /25 (128 IP 주소)
  - /26 (64 IP 주소)
  - /27 (32 IP 주소)

- **서브넷 유형**:
  - **퍼블릭 서브넷**: 인터넷 게이트웨이를 통한 직접 인터넷 액세스
  - **프라이빗 서브넷**: 인터넷에 직접 액세스할 수 없음
  - **데이터베이스 서브넷**: 데이터베이스 전용 격리된 서브넷

- **가용 영역 분산**:
  - 각 가용 영역에 동일한 유형의 서브넷 배치
  - 고가용성을 위해 최소 2개 이상의 AZ 사용

- **명명 규칙**:
  - 서브넷 유형 식별 가능한 이름 사용
  - 가용 영역 정보 포함
  - 예: Public-Subnet-AZ1, Private-Subnet-AZ1

#### IP 주소 할당 전략
- **예약 IP 범위**:
  - 향후 확장을 위한 IP 범위 예약
  - 특수 용도(VPN, Direct Connect 등)를 위한 IP 범위 예약

- **서브넷 그룹화**:
  - 유사한 기능의 리소스를 동일한 서브넷에 배치
  - 보안 및 라우팅 정책 적용 용이

- **자동 vs 수동 IP 할당**:
  - 대부분의 경우 자동 할당 사용
  - 중요 인프라는 수동으로 고정 IP 할당 고려

### 가용성 및 내결함성
VPC 설계 시 고가용성과 내결함성을 고려하는 것이 중요합니다.

#### 다중 가용 영역 설계
- 최소 2개 이상의 가용 영역 사용
- 각 가용 영역에 동일한 구성 배포
- 가용 영역 간 리소스 균형 유지
- 자동 장애 조치 메커니즘 구현

#### 중복 네트워크 경로
- 다중 NAT 게이트웨이 (가용 영역별)
- 다중 VPN 연결 또는 Direct Connect
- 다중 Transit Gateway 연결
- 장애 시 자동 라우팅 변경 구성

#### 고가용성 네트워크 서비스
- 로드 밸런서를 통한 트래픽 분산
- 자동 확장 그룹을 통한 용량 관리
- 상태 확인 및 자동 복구 메커니즘
- 리전 간 장애 조치 고려

### 보안 설계
VPC의 보안은 여러 계층에서 구현되어야 합니다.

#### 심층 방어 전략
- 여러 보안 계층 구현
- 네트워크 세분화 및 격리
- 최소 권한 원칙 적용
- 기본적으로 모든 액세스 거부, 필요한 액세스만 허용

#### 네트워크 세분화
- 기능별 서브넷 분리
- 보안 요구 사항에 따른 네트워크 분리
- 마이크로 세분화를 통한 세밀한 액세스 제어
- 데이터 민감도에 따른 격리

#### 트래픽 제어
- 인바운드/아웃바운드 트래픽 필터링
- 계층적 보안 그룹 설계
- 세분화된 NACL 규칙
- 트래픽 검사 및 모니터링

#### 암호화 및 보안 통신
- 전송 중 데이터 암호화 (TLS/SSL)
- VPN 또는 Direct Connect를 통한 보안 연결
- 프라이빗 엔드포인트를 통한 서비스 액세스
- 엔드-투-엔드 암호화 고려

### 확장성 설계
VPC는 비즈니스 성장에 따라 확장 가능하도록 설계되어야 합니다.

#### 미래 성장 고려
- 충분히 큰 CIDR 블록 선택
- 확장을 위한 IP 주소 공간 예약
- 모듈식 설계로 쉬운 확장 가능
- 자동화된 인프라 배포

#### 수평적 확장
- 여러 가용 영역에 걸친 리소스 배포
- 자동 확장 그룹 활용
- 로드 밸런서를 통한 트래픽 분산
- 상태 비저장 아키텍처 설계

#### 리소스 제한 관리
- VPC 및 서브넷 제한 이해
- 서비스 할당량 모니터링
- 필요 시 할당량 증가 요청
- 리소스 사용량 예측 및 계획

## VPC 설계 패턴

### 기본 VPC 설계
가장 일반적이고 기본적인 VPC 설계 패턴입니다.

#### 구성 요소
- 단일 VPC (예: 10.0.0.0/16)
- 여러 가용 영역에 걸친 퍼블릭 및 프라이빗 서브넷
- 인터넷 게이트웨이
- NAT 게이트웨이 (각 가용 영역에 하나씩)
- 적절한 라우팅 테이블

#### 설계 다이어그램
```
VPC (10.0.0.0/16)
|
|-- 가용 영역 A
|   |-- 퍼블릭 서브넷 A (10.0.0.0/24)
|   |   |-- 인터넷 게이트웨이
|   |   |-- NAT 게이트웨이 A
|   |   |-- 퍼블릭 인스턴스 (웹 서버 등)
|   |
|   |-- 프라이빗 서브넷 A (10.0.1.0/24)
|       |-- 프라이빗 인스턴스 (애플리케이션 서버 등)
|       |-- 데이터베이스 인스턴스
|
|-- 가용 영역 B
    |-- 퍼블릭 서브넷 B (10.0.2.0/24)
    |   |-- NAT 게이트웨이 B
    |   |-- 퍼블릭 인스턴스 (웹 서버 등)
    |
    |-- 프라이빗 서브넷 B (10.0.3.0/24)
        |-- 프라이빗 인스턴스 (애플리케이션 서버 등)
        |-- 데이터베이스 인스턴스
```

#### 사용 사례
- 대부분의 웹 애플리케이션
- 3계층 아키텍처 (웹, 애플리케이션, 데이터베이스)
- 중소 규모 워크로드
- 개발, 테스트, 프로덕션 환경

### 격리된 서브넷 설계
보안 요구 사항이 높은 워크로드를 위한 추가 격리를 제공하는 설계입니다.

#### 구성 요소
- 기본 VPC 설계의 모든 구성 요소
- 추가 격리된 서브넷 (데이터베이스, 규제 대상 워크로드 등)
- 세분화된 라우팅 및 보안 제어

#### 설계 다이어그램
```
VPC (10.0.0.0/16)
|
|-- 가용 영역 A
|   |-- 퍼블릭 서브넷 A (10.0.0.0/24)
|   |-- 프라이빗 애플리케이션 서브넷 A (10.0.1.0/24)
|   |-- 프라이빗 데이터베이스 서브넷 A (10.0.2.0/24)
|   |-- 격리된 규제 대상 서브넷 A (10.0.3.0/24)
|
|-- 가용 영역 B
    |-- 퍼블릭 서브넷 B (10.0.4.0/24)
    |-- 프라이빗 애플리케이션 서브넷 B (10.0.5.0/24)
    |-- 프라이빗 데이터베이스 서브넷 B (10.0.6.0/24)
    |-- 격리된 규제 대상 서브넷 B (10.0.7.0/24)
```

#### 사용 사례
- 금융 서비스 애플리케이션
- 의료 데이터 처리 시스템
- PCI DSS 규정 준수 워크로드
- 다중 테넌트 애플리케이션

### 트랜짓 VPC 설계
여러 VPC 또는 온프레미스 네트워크를 연결하는 중앙 허브 역할을 하는 VPC 설계입니다.

#### 구성 요소
- 중앙 트랜짓 VPC
- 여러 스포크 VPC (워크로드별)
- Transit Gateway 또는 VPC 피어링
- 중앙 집중식 보안 및 모니터링

#### 설계 다이어그램
```
                온프레미스 네트워크
                       |
                       | (VPN/Direct Connect)
                       |
                트랜짓 VPC (10.0.0.0/16)
                /      |      \
               /       |       \
              /        |        \
개발 VPC      /         |         \     프로덕션 VPC
(10.1.0.0/16)    테스트 VPC    (10.3.0.0/16)
                (10.2.0.0/16)
```

#### 사용 사례
- 대규모 조직의 다중 환경 (개발, 테스트, 프로덕션)
- 하이브리드 클라우드 아키텍처
- 중앙 집중식 네트워크 제어가 필요한 경우
- 여러 비즈니스 단위 또는 애플리케이션 지원

### 다중 VPC 설계
각 워크로드 또는 환경에 대해 별도의 VPC를 사용하는 설계입니다.

#### 구성 요소
- 환경별 또는 워크로드별 전용 VPC
- VPC 간 연결 (필요한 경우)
- 환경별 격리 및 제어
- 중앙 집중식 관리 (AWS Organizations, Control Tower 등)

#### 설계 다이어그램
```
개발 VPC (10.1.0.0/16)     테스트 VPC (10.2.0.0/16)     프로덕션 VPC (10.3.0.0/16)
|                         |                           |
|-- 퍼블릭 서브넷          |-- 퍼블릭 서브넷            |-- 퍼블릭 서브넷
|-- 프라이빗 서브넷        |-- 프라이빗 서브넷          |-- 프라이빗 서브넷
|-- 데이터베이스 서브넷     |-- 데이터베이스 서브넷       |-- 데이터베이스 서브넷
```

#### 사용 사례
- 환경 간 완전한 격리 필요
- 다양한 규정 준수 요구 사항
- 다중 테넌트 SaaS 애플리케이션
- 서로 다른 팀이 관리하는 워크로드

## VPC 설계 모범 사례

### 네트워크 설계 모범 사례
- **충분한 IP 주소 공간 할당**: 미래 성장을 고려한 CIDR 블록 선택
- **일관된 서브넷 크기**: 관리 용이성을 위해 일관된 서브넷 크기 사용
- **다중 가용 영역 설계**: 고가용성을 위해 최소 2개 이상의 AZ 사용
- **서브넷 목적 분리**: 기능 및 보안 요구 사항에 따라 서브넷 분리
- **일관된 명명 규칙**: 리소스 식별 및 관리를 위한 명확한 명명 규칙 사용

### 보안 모범 사례
- **최소 권한 원칙**: 필요한 최소한의 액세스만 허용
- **다중 보안 계층**: 보안 그룹, NACL, 서브넷 분리 등 여러 보안 계층 구현
- **기본 거부 정책**: 기본적으로 모든 액세스 거부, 필요한 액세스만 명시적으로 허용
- **트래픽 암호화**: 전송 중 데이터 암호화 (TLS/SSL, VPN 등)
- **로깅 및 모니터링**: VPC 흐름 로그 및 CloudTrail 활성화

### 확장성 모범 사례
- **모듈식 설계**: 독립적으로 확장 가능한 구성 요소로 설계
- **자동화**: 인프라 배포 및 구성 자동화 (CloudFormation, Terraform 등)
- **서비스 할당량 모니터링**: 리소스 제한 모니터링 및 필요 시 증가 요청
- **미래 성장 계획**: 추가 서브넷, VPC, 연결 옵션 등을 위한 공간 예약

### 비용 최적화 모범 사례
- **NAT 게이트웨이 공유**: 비용 절감을 위해 여러 서브넷에서 NAT 게이트웨이 공유
- **VPC 엔드포인트 활용**: 데이터 전송 비용 절감을 위한 VPC 엔드포인트 사용
- **적절한 연결 옵션 선택**: 요구 사항에 맞는 가장 비용 효율적인 연결 옵션 선택
- **리소스 사용량 모니터링**: 불필요한 리소스 식별 및 제거

## 결론
Amazon VPC는 AWS 클라우드 내에서 안전하고 확장 가능한 네트워크 환경을 구축하기 위한 핵심 서비스입니다. VPC의 기본 개념, 구성 요소, 설계 원칙을 이해하면 다양한 워크로드 요구 사항에 맞는 효과적인 네트워크 아키텍처를 설계할 수 있습니다. IP 주소 계획, 가용성, 보안, 확장성을 고려한 VPC 설계는 안정적이고 안전한 클라우드 인프라의 기반이 됩니다.

## 참고 자료
- [Amazon VPC 사용 설명서](https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html)
- [AWS 아키텍처 센터 - VPC 설계 패턴](https://aws.amazon.com/architecture/vpc-design/)
- [AWS Well-Architected Framework - 보안 원칙](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/welcome.html)
- [VPC 네트워킹 구성 요소](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Networking.html)
- [IP 주소 지정 및 서브넷 설계](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-ip-addressing.html)